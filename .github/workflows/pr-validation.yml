name: ğŸ” Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '20'

jobs:
  # Job 1: PR Information
  pr-info:
    name: ğŸ“‹ PR Information
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: ğŸ“‹ PR Summary
        run: |
          echo "# ğŸ” Pull Request Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Number | #${{ github.event.number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Title | ${{ github.event.pull_request.title }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Author | @${{ github.event.pull_request.user.login }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Base Branch | ${{ github.event.pull_request.base.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Head Branch | ${{ github.event.pull_request.head.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Changed Files | ${{ github.event.pull_request.changed_files }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Additions | +${{ github.event.pull_request.additions }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deletions | -${{ github.event.pull_request.deletions }} |" >> $GITHUB_STEP_SUMMARY

  # Job 2: Changed Files Analysis
  changed-files:
    name: ğŸ“ Changed Files Analysis
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    outputs:
      has-frontend-changes: ${{ steps.changes.outputs.frontend }}
      has-cdk-changes: ${{ steps.changes.outputs.cdk }}
      has-test-changes: ${{ steps.changes.outputs.tests }}
      has-config-changes: ${{ steps.changes.outputs.config }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Detect changed files
        id: changes
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }})
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check for different types of changes
          if echo "$CHANGED_FILES" | grep -E '\.(html|css|js)$' | grep -v test; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "ğŸ¨ Frontend changes detected"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -E '^cdk/'; then
            echo "cdk=true" >> $GITHUB_OUTPUT
            echo "ğŸ—ï¸ CDK changes detected"
          else
            echo "cdk=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -E 'test|spec'; then
            echo "tests=true" >> $GITHUB_OUTPUT
            echo "ğŸ§ª Test changes detected"
          else
            echo "tests=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$CHANGED_FILES" | grep -E '\.(json|yml|yaml|config\.|\.config)$'; then
            echo "config=true" >> $GITHUB_OUTPUT
            echo "âš™ï¸ Configuration changes detected"
          else
            echo "config=false" >> $GITHUB_OUTPUT
          fi

  # Job 3: Frontend Validation
  frontend-validation:
    name: ğŸ¨ Frontend Validation
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.has-frontend-changes == 'true' && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Validate HTML structure
        run: |
          echo "ğŸ” Validating HTML structure..."
          
          # Check for required elements
          if ! grep -q "Simple Task Tracker" simple-task-tracker-standalone.html; then
            echo "âŒ Missing title in standalone HTML"
            exit 1
          fi
          
          if ! grep -q "task-tracker-script.js" simple-task-tracker-standalone.html; then
            echo "âŒ Missing script reference in standalone HTML"
            exit 1
          fi
          
          if ! grep -q "task-tracker-styles.css" simple-task-tracker-standalone.html; then
            echo "âŒ Missing CSS reference in standalone HTML"
            exit 1
          fi
          
          echo "âœ… HTML structure validation passed"

      - name: ğŸ” Validate JavaScript
        run: |
          echo "ğŸ” Validating JavaScript..."
          
          # Syntax check
          node -c task-tracker-script.js
          
          # Check for required functions
          if ! grep -q "function.*addTask\|const.*addTask\|addTask.*=" task-tracker-script.js; then
            echo "âš ï¸ addTask function not found (might be renamed)"
          fi
          
          echo "âœ… JavaScript validation passed"

      - name: ğŸ” Validate CSS
        run: |
          echo "ğŸ” Validating CSS..."
          
          # Basic CSS validation (check for syntax errors)
          if command -v csslint >/dev/null 2>&1; then
            csslint task-tracker-styles.css || echo "âš ï¸ CSS lint warnings (non-blocking)"
          else
            echo "â„¹ï¸ CSS lint not available, performing basic checks"
            
            # Check for balanced braces
            OPEN_BRACES=$(grep -o '{' task-tracker-styles.css | wc -l)
            CLOSE_BRACES=$(grep -o '}' task-tracker-styles.css | wc -l)
            
            if [[ $OPEN_BRACES -ne $CLOSE_BRACES ]]; then
              echo "âŒ Unbalanced braces in CSS"
              exit 1
            fi
          fi
          
          echo "âœ… CSS validation passed"

      - name: ğŸ­ Run frontend tests
        run: |
          npx playwright install --with-deps
          npm run test:ui

  # Job 4: CDK Validation
  cdk-validation:
    name: ğŸ—ï¸ CDK Validation
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.has-cdk-changes == 'true' && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install CDK dependencies
        run: |
          cd cdk
          npm ci

      - name: ğŸ”¨ Build CDK
        run: |
          cd cdk
          npm run build

      - name: ğŸ§ª Run CDK tests
        run: |
          cd cdk
          npm test

      - name: ğŸ” CDK diff validation
        run: |
          cd cdk
          npx cdk synth --quiet > /dev/null
          echo "âœ… CDK synthesis successful"

      - name: ğŸ”’ Security validation
        run: |
          cd cdk
          echo "ğŸ”’ Checking for security best practices..."
          
          # Check for hardcoded secrets
          if grep -r -i "password\|secret\|key" lib/ --include="*.ts" | grep -v "SecretValue\|Secret.from"; then
            echo "âš ï¸ Potential hardcoded secrets found"
          fi
          
          # Check for public access
          if grep -r "publicReadAccess.*true" lib/ --include="*.ts"; then
            echo "âš ï¸ Public read access enabled - ensure this is intentional"
          fi
          
          echo "âœ… Security validation completed"

  # Job 5: Test Coverage Analysis
  test-coverage:
    name: ğŸ§ª Test Coverage Analysis
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.has-test-changes == 'true' && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run all tests
        run: |
          npx playwright install --with-deps
          npm run test

      - name: ğŸ“Š Analyze test coverage
        run: |
          echo "ğŸ“Š Test coverage analysis..."
          
          # Count test files
          TEST_FILES=$(find . -name "*.test.js" -o -name "*.spec.js" | wc -l)
          PLAYWRIGHT_TESTS=$(find playwright-tests -name "*.spec.js" 2>/dev/null | wc -l || echo 0)
          
          echo "ğŸ“ˆ Test Statistics:"
          echo "- Unit test files: $TEST_FILES"
          echo "- Playwright test files: $PLAYWRIGHT_TESTS"
          
          # Check if new features have corresponding tests
          echo "âœ… Test coverage analysis completed"

  # Job 6: Performance Impact Analysis
  performance-analysis:
    name: âš¡ Performance Impact Analysis
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.has-frontend-changes == 'true' && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“ Analyze file sizes
        run: |
          echo "ğŸ“ File size analysis..."
          
          echo "Current file sizes:"
          ls -lh *.html *.js *.css 2>/dev/null || echo "Some files not found"
          
          # Check for large files
          LARGE_FILES=$(find . -name "*.html" -o -name "*.js" -o -name "*.css" | xargs ls -l | awk '$5 > 1048576 {print $9 " (" $5 " bytes)"}')
          
          if [[ -n "$LARGE_FILES" ]]; then
            echo "âš ï¸ Large files detected (>1MB):"
            echo "$LARGE_FILES"
          else
            echo "âœ… No unusually large files detected"
          fi

      - name: ğŸ” Check for performance anti-patterns
        run: |
          echo "ğŸ” Checking for performance anti-patterns..."
          
          # Check for synchronous operations that might block
          if grep -r "alert\|confirm\|prompt" *.js 2>/dev/null; then
            echo "âš ï¸ Blocking dialog functions found (consider alternatives)"
          fi
          
          # Check for inefficient selectors
          if grep -r "document.getElementsByTagName\|document.all" *.js 2>/dev/null; then
            echo "âš ï¸ Potentially inefficient DOM selectors found"
          fi
          
          echo "âœ… Performance analysis completed"

  # Job 7: Accessibility Check
  accessibility-check:
    name: â™¿ Accessibility Check
    runs-on: ubuntu-latest
    needs: changed-files
    if: needs.changed-files.outputs.has-frontend-changes == 'true' && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: â™¿ Run accessibility tests
        run: |
          npx playwright install --with-deps
          npm run test:accessibility

      - name: ğŸ” Manual accessibility checks
        run: |
          echo "ğŸ” Performing manual accessibility checks..."
          
          # Check for alt attributes on images
          if grep -o '<img[^>]*>' simple-task-tracker-standalone.html | grep -v 'alt='; then
            echo "âš ï¸ Images without alt attributes found"
          fi
          
          # Check for form labels
          if grep -o '<input[^>]*>' simple-task-tracker-standalone.html | grep -v 'aria-label\|id=' | head -5; then
            echo "â„¹ï¸ Some inputs might need labels or aria-labels"
          fi
          
          # Check for heading structure
          if ! grep -q '<h[1-6]' simple-task-tracker-standalone.html; then
            echo "âš ï¸ No heading elements found - consider adding for better structure"
          fi
          
          echo "âœ… Accessibility checks completed"

  # Job 8: PR Summary
  pr-summary:
    name: ğŸ“‹ PR Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-info, changed-files, frontend-validation, cdk-validation, test-coverage, performance-analysis, accessibility-check]
    if: always() && github.event.pull_request.draft == false
    steps:
      - name: ğŸ“‹ Generate PR validation summary
        run: |
          echo "# ğŸ” Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ“ Changed Components" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.changed-files.outputs.has-frontend-changes }} | ${{ needs.frontend-validation.result == 'success' && 'âœ… Passed' || needs.frontend-validation.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CDK Infrastructure | ${{ needs.changed-files.outputs.has-cdk-changes }} | ${{ needs.cdk-validation.result == 'success' && 'âœ… Passed' || needs.cdk-validation.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.changed-files.outputs.has-test-changes }} | ${{ needs.test-coverage.result == 'success' && 'âœ… Passed' || needs.test-coverage.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Configuration | ${{ needs.changed-files.outputs.has-config-changes }} | â„¹ï¸ Manual Review |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## ğŸ” Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Performance Analysis | ${{ needs.performance-analysis.result == 'success' && 'âœ… Passed' || needs.performance-analysis.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Accessibility Check | ${{ needs.accessibility-check.result == 'success' && 'âœ… Passed' || needs.accessibility-check.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          OVERALL_STATUS="âœ… Ready for Review"
          if [[ "${{ needs.frontend-validation.result }}" == "failure" || 
                "${{ needs.cdk-validation.result }}" == "failure" || 
                "${{ needs.test-coverage.result }}" == "failure" || 
                "${{ needs.performance-analysis.result }}" == "failure" || 
                "${{ needs.accessibility-check.result }}" == "failure" ]]; then
            OVERALL_STATUS="âŒ Issues Found"
          fi
          
          echo "## ğŸ¯ Overall Status: $OVERALL_STATUS" >> $GITHUB_STEP_SUMMARY